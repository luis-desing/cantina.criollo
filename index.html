<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>Stock de Vinos</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 0; 
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    main {
      flex: 1;
    }
    h1 {
      text-align: center;
      color: #4a90e2;
      margin-top: 20px;
      font-size: 24px;
    }
    .contenedor-stock {
      margin: 20px auto;
      padding: 20px;
      border-radius: 10px;
      background-color: #fff;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 500px;
    }
    #vinosTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    #vinosTable th,
    #vinosTable td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
      vertical-align: middle;
    }
    #vinosTable th {
      background-color: #f0f4f8;
      font-weight: bold;
      color: #333;
    }
    #vinosTable tbody tr:nth-child(odd) {
      background-color: #f9f9f9;
    }
    #vinosTable tbody tr:hover {
      background-color: #f1f1f1;
    }
    #vinosTable td input[type="number"] {
      width: 60px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #fff;
      font-size: 16px;
      text-align: center;
      box-sizing: border-box;
    }
    .boton-actualizar, .boton-borrar {
      display: block;
      width: 100%;
      margin-top: 10px;
      padding: 15px;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      box-sizing: border-box;
    }
    .boton-actualizar {
      background-color: #4a90e2;
    }
    .boton-actualizar:hover:not(:disabled) {
      background-color: #357abd;
    }
    .boton-actualizar:disabled {
      background-color: #a0c4e9;
      cursor: not-allowed;
    }
    .boton-borrar {
      background-color: #dc3545;
    }
    .boton-borrar:hover:not(:disabled) {
      background-color: #c82333;
    }
    #statusMessage {
      margin-top: 15px;
      text-align: center;
      font-weight: bold;
    }
    .success { color: green; }
    .error { color: red; }
    #ultimaModificacion {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
      color: #555;
    }
    .contenedor-almanaque {
      margin: 10px auto;
      text-align: center;
    }
    .contenedor-almanaque label {
      margin-right: 10px;
      font-weight: bold;
    }
    .contenedor-almanaque input[type="date"] {
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
    }
    footer {
      text-align: center;
      padding: 15px 0;
      background-color: #e9ecef;
      color: #6c757d;
      border-top: 1px solid #dee2e6;
      margin-top: 30px;
      width: 100%;
    }
  </style>
</head>
<body>
  <main>
    <h1>Stock de Vinos</h1>
    <div class="contenedor-stock">
      <div class="contenedor-almanaque">
        <label for="fechaConsulta">Consultar stock histórico:</label>
        <input type="date" id="fechaConsulta">
      </div>
      <table id="vinosTable">
        <thead>
          <tr>
            <th>Vino</th>
            <th>Cantidad</th>
          </tr>
        </thead>
        <tbody id="vinosTableBody">
          <!-- Las filas se generarán con JavaScript -->
        </tbody>
      </table>
      <button id="actualizar-stock" class="boton-actualizar" disabled>Actualizar Stock</button>
      <button id="borrar-stock" class="boton-borrar">Borrar Stock Actual</button>
      <div id="statusMessage"></div>
      <div id="ultimaModificacion"></div>
    </div>
  </main>
  <footer>
    <p>© 2025 Cantina L.</p>
  </footer>
  <script>
    // --- Datos de Vinos ---
    const listaVinos = [
      'Caramañola Tinto 375', 'Caramañola Blanco 375', 'Caramañola Tinto 750',
      'Caramañola Blanco 750', 'San Felipe Roble', 'San Humberto Reserva',
      'San Humberto Centenario', 'San Humberto Joven', 'San Humberto Chardonnay',
      'Cruz Alta Malbec', 'Cruz Alta Chardonnay', 'La Vuelta', 'Cepa Tradicional',
      'Sade', 'Trumpeter'
    ];

    // --- Configuración ---
    // !!! ASEGÚRATE DE QUE ESTA ES LA URL /exec DE TU IMPLEMENTACIÓN ACTIVA Y CORRECTAMENTE CONFIGURADA !!!
    const API_URL = 'https://script.google.com/macros/s/AKfycbzmmK_3-wvwY8XYpxGWWIV8-bSDnFSyaPUulmLLqkE1LThj8D7sQBFH6IvBV8b9M9lQgQ/exec';

    // --- Elementos del DOM ---
    let vinosTableBody = document.getElementById('vinosTableBody');
    let actualizarStockButton = document.getElementById('actualizar-stock');
    let borrarStockButton = document.getElementById('borrar-stock');
    let statusMessageDiv = document.getElementById('statusMessage');
    let ultimaModificacionDiv = document.getElementById('ultimaModificacion');
    let fechaConsultaInput = document.getElementById('fechaConsulta');

    let debounceTimeout;
    let isSaving = false; // Bandera para evitar múltiples guardados simultáneos

    // --- Funciones ---

    const inicializarElementosDOM = () => {
      if (!vinosTableBody) {
        console.error('Error: No se encontró el elemento #vinosTableBody');
        // Podrías intentar obtenerlo de nuevo o mostrar un error más visible al usuario
        vinosTableBody = document.getElementById('vinosTableBody');
        if (!vinosTableBody) return false;
      }
      // Similar para otros elementos críticos si es necesario
      actualizarStockButton = document.getElementById('actualizar-stock');
      borrarStockButton = document.getElementById('borrar-stock');
      statusMessageDiv = document.getElementById('statusMessage');
      ultimaModificacionDiv = document.getElementById('ultimaModificacion');
      fechaConsultaInput = document.getElementById('fechaConsulta');

      return !!(vinosTableBody && actualizarStockButton && borrarStockButton && statusMessageDiv && ultimaModificacionDiv && fechaConsultaInput);
    };

    const generarTablaVinos = (vinos, stockActual = {}) => {
      console.log('Generando tabla con vinos:', vinos, 'y stock:', stockActual);
      if (!vinosTableBody) {
        console.error("vinosTableBody no está definido al generar tabla.");
        return;
      }
      vinosTableBody.innerHTML = '';
      if (!vinos || vinos.length === 0) {
        const fila = document.createElement('tr');
        const celda = document.createElement('td');
        celda.colSpan = 2;
        celda.textContent = 'No hay vinos definidos.';
        celda.style.textAlign = 'center';
        fila.appendChild(celda);
        vinosTableBody.appendChild(fila);
        return;
      }
      vinos.forEach(vino => {
        const fila = document.createElement('tr');
        const vinoCelda = document.createElement('td');
        vinoCelda.textContent = vino;
        const cantidadCelda = document.createElement('td');
        const inputCantidad = document.createElement('input');
        inputCantidad.type = 'number';
        inputCantidad.value = stockActual[vino] !== undefined ? stockActual[vino] : ''; // Manejar 0 explícitamente
        inputCantidad.min = '0';
        inputCantidad.placeholder = '0';
        inputCantidad.dataset.vino = vino;
        cantidadCelda.appendChild(inputCantidad);
        fila.appendChild(vinoCelda);
        fila.appendChild(cantidadCelda);
        vinosTableBody.appendChild(fila);
      });
      actualizarEstadoBoton();
    };

    const actualizarEstadoBoton = () => {
      if (!actualizarStockButton) return;
      const inputsCantidad = vinosTableBody.querySelectorAll('input[type="number"]');
      let hayDatosParaGuardar = false; // Cambiado para reflejar si hay algo que guardar, no solo datos
      inputsCantidad.forEach(input => {
        const cantidad = parseInt(input.value, 10);
        if (!isNaN(cantidad) && cantidad >= 0 && input.value.trim() !== '') { // Considerar campo no vacío
            hayDatosParaGuardar = true;
        }
      });
      actualizarStockButton.disabled = !hayDatosParaGuardar || isSaving;
    };

    const mostrarMensaje = (message, isError = false) => {
      if (!statusMessageDiv) return;
      statusMessageDiv.textContent = message;
      statusMessageDiv.className = isError ? 'error' : 'success';
      console.log(isError ? 'Error mostrado:' : 'Mensaje mostrado:', message);
    };

    const formatearFecha = (fechaStr) => {
      if (!fechaStr) return 'No hay modificaciones previas';
      const fecha = new Date(fechaStr);
      if (isNaN(fecha.getTime())) return 'Fecha inválida'; // Chequeo extra
      return fecha.toLocaleString('es-AR', {
        year: 'numeric', month: 'numeric', day: 'numeric',
        hour: '2-digit', minute: '2-digit' // Formato más explícito
      });
    };

    const actualizarTablaConStock = (stock) => {
      if (!vinosTableBody) return;
      const inputsCantidad = vinosTableBody.querySelectorAll('input[type="number"]');
      inputsCantidad.forEach(input => {
        const vino = input.dataset.vino;
        if (stock[vino] !== undefined) {
          input.value = stock[vino];
        } else {
          input.value = '';
        }
      });
      actualizarEstadoBoton();
    };

    const recopilarDatosStock = () => {
      if (!vinosTableBody) return [];
      const filas = vinosTableBody.querySelectorAll('tr');
      let stockItems = [];
      filas.forEach(fila => {
        const vinoCelda = fila.querySelector('td:first-child');
        const cantidadInput = fila.querySelector('input[type="number"]');
        if (vinoCelda && cantidadInput) {
          const cantidad = parseInt(cantidadInput.value, 10);
          // Solo incluir si la cantidad es un número válido y no está vacío
          // Si el input está vacío, cantidadInput.value será "", e parseInt("") es NaN
          if (cantidadInput.value.trim() !== '' && !isNaN(cantidad) && cantidad >= 0) {
            const vino = vinoCelda.textContent.trim();
            stockItems.push({ vino, cantidad });
          }
        }
      });
      return stockItems;
    };

    const enviarAlServidor = async (action, payload = {}) => {
        isSaving = true;
        actualizarEstadoBoton(); // Deshabilitar botón mientras se guarda

        const body = JSON.stringify({ action, ...payload });
        console.log(`Enviando a servidor. Acción: ${action}, Payload:`, payload);

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // 'Content-Length': body.length // Dejar que fetch lo maneje
                },
                body: body,
                mode: 'cors', // Necesario para peticiones cross-origin
                // redirect: 'follow', // Google Apps Script a veces hace redirects para auth
            });

            // Intenta parsear como JSON incluso si no es ok, para obtener mensajes de error del script
            let result;
            const responseText = await response.text();
            try {
                result = JSON.parse(responseText);
            } catch (e) {
                // Si la respuesta no es JSON, usar el texto como error
                console.error("Respuesta no es JSON:", responseText);
                throw new Error(`Respuesta inesperada del servidor (HTTP ${response.status}): ${responseText.substring(0,100)}...`);
            }
            
            console.log('Respuesta del servidor:', result);

            if (!response.ok || !result.success) {
                const errorMessage = result.error || `Error del servidor (HTTP ${response.status})`;
                throw new Error(errorMessage);
            }
            return result;

        } catch (error) {
            console.error(`Error en la comunicación con el servidor (${action}):`, error);
            mostrarMensaje(`Error en ${action}: ${error.message}`, true);
            throw error; // Re-lanzar para que el llamador pueda manejarlo
        } finally {
            isSaving = false;
            actualizarEstadoBoton();
        }
    };


    const guardarStockEnServidor = async () => {
      const stockItems = recopilarDatosStock();
      // Aunque el botón se deshabilita si no hay datos, una doble verificación es buena.
      if (stockItems.length === 0 && !confirm("No hay cantidades ingresadas. ¿Deseas guardar un stock vacío (borrará el stock actual en la hoja 'Stock')?")) {
        mostrarMensaje('Guardado cancelado. No se ingresaron cantidades.', false);
        // Si no hay items, no se envia nada, pero se limpian los inputs.
        // Opcionalmente, podrías no hacer nada aquí si el usuario cancela.
        // cargarDatosIniciales(); // Para recargar el último estado guardado
        return;
      }
      // Si el usuario confirma guardar un stock vacío, stockItems será un array vacío.
      // El backend procesarStockVinos lo manejará limpiando la hoja de stock.

      mostrarMensaje('Guardando cambios...', false); // Mensaje optimista
      try {
        const result = await enviarAlServidor('procesarStockVinos', { stockItems });
        mostrarMensaje('Stock actualizado con éxito!', false);
        if (ultimaModificacionDiv && result.ultimaModificacion) {
          ultimaModificacionDiv.textContent = `Última modificación: ${formatearFecha(result.ultimaModificacion)}`;
        }
        cargarFechasConRegistros(); // Actualizar indicador de fechas
      } catch (error) {
        // El mensaje de error ya se muestra en enviarAlServidor
      }
    };

    const borrarStockActualEnServidor = async () => {
      if (!confirm('¿Estás seguro de que deseas borrar el stock actual? Esta acción no se puede deshacer.')) {
        return;
      }
      mostrarMensaje('Borrando stock...', false);
      try {
        const result = await enviarAlServidor('borrarStockActual');
        mostrarMensaje('Stock actual borrado con éxito!', false);
        actualizarTablaConStock({}); // Limpiar la tabla en el frontend
        if (ultimaModificacionDiv && result.ultimaModificacion) {
          ultimaModificacionDiv.textContent = `Última modificación: ${formatearFecha(result.ultimaModificacion)}`;
        }
        cargarFechasConRegistros();
      } catch (error) {
        // El mensaje de error ya se muestra en enviarAlServidor
      }
    };

    const cargarDatosIniciales = async () => {
      console.log('Iniciando carga de datos iniciales desde el servidor...');
      mostrarMensaje('Cargando datos iniciales...', false);
      try {
        const response = await fetch(`${API_URL}?action=obtenerDatosIniciales`, {
          method: 'GET',
          mode: 'cors',
          // redirect: 'follow',
        });
        
        let result;
        const responseText = await response.text();
        try {
            result = JSON.parse(responseText);
        } catch (e) {
            console.error("Respuesta de obtenerDatosIniciales no es JSON:", responseText);
            throw new Error(`Respuesta inesperada del servidor (HTTP ${response.status}): ${responseText.substring(0,100)}...`);
        }

        console.log('Datos iniciales recibidos del servidor:', result);

        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Error desconocido al cargar datos iniciales');
        }
        
        generarTablaVinos(listaVinos, result.data.stock || {}); // Asegurar que la tabla se genera/regenera con los vinos
        // actualizarTablaConStock(result.data.stock || {}); // Esto podría ser redundante si generarTablaVinos ya lo hace
        if (ultimaModificacionDiv && result.data.ultimaModificacion) {
          ultimaModificacionDiv.textContent = `Última modificación: ${formatearFecha(result.data.ultimaModificacion)}`;
        }
        mostrarMensaje('Datos cargados.', false);
        cargarFechasConRegistros(); // Cargar después de que los datos principales estén listos
      } catch (error) {
        console.error('Error al cargar datos del servidor:', error);
        mostrarMensaje(`Error al cargar datos: ${error.message}. Puedes seguir trabajando offline con los datos predefinidos.`, true);
        generarTablaVinos(listaVinos, {}); // Generar tabla vacía si falla la carga
      }
    };

    const consultarStockHistorico = async (fecha) => {
      if (!fecha) {
        mostrarMensaje('Por favor, seleccione una fecha.', true);
        cargarDatosIniciales(); // Volver al stock actual si se deselecciona la fecha
        return;
      }
      mostrarMensaje(`Consultando stock para ${fecha}...`, false);
      try {
        const response = await fetch(`${API_URL}?action=obtenerStockHistorico&fecha=${fecha}`, {
          method: 'GET',
          mode: 'cors',
          // redirect: 'follow',
        });
        
        let result;
        const responseText = await response.text();
        try {
            result = JSON.parse(responseText);
        } catch (e) {
            console.error(`Respuesta de obtenerStockHistorico (${fecha}) no es JSON:`, responseText);
            throw new Error(`Respuesta inesperada del servidor (HTTP ${response.status}): ${responseText.substring(0,100)}...`);
        }
        
        console.log(`Stock histórico para ${fecha} recibido:`, result);

        if (!response.ok || !result.success) {
          throw new Error(result.error || `Error al obtener stock histórico para ${fecha}`);
        }

        if (result.data && result.data.stock && Object.keys(result.data.stock).length > 0) {
          // Volver a generar la tabla con la lista completa de vinos, y el stock histórico para esa fecha
          generarTablaVinos(listaVinos, result.data.stock);
          mostrarMensaje(`Stock cargado para la fecha ${result.data.fechaRegistro}`, false);
        } else {
          generarTablaVinos(listaVinos, {}); // Mostrar tabla vacía si no hay datos
          mostrarMensaje(`No se encontraron datos para la fecha ${fecha}.`, true);
        }
      } catch (error) {
        console.error('Error al consultar stock histórico:', error);
        mostrarMensaje(`Error al consultar stock histórico: ${error.message}`, true);
        generarTablaVinos(listaVinos, {}); // Mostrar tabla vacía en caso de error
      }
    };

    const cargarFechasConRegistros = async () => {
      try {
        const response = await fetch(`${API_URL}?action=obtenerFechasConRegistros`, {
          method: 'GET',
          mode: 'cors',
          // redirect: 'follow',
        });
        
        let result;
        const responseText = await response.text();
        try {
            result = JSON.parse(responseText);
        } catch (e) {
            console.error("Respuesta de obtenerFechasConRegistros no es JSON:", responseText);
            // No mostrar error crítico por esto, es una mejora visual
            console.warn("No se pudieron cargar las fechas con registros para el calendario.");
            return;
        }

        if (!response.ok || !result.success) {
          console.warn(result.error || 'Error desconocido al cargar fechas con registros.');
          return;
        }
        
        if (result.data && result.data.fechas) {
          const fechas = result.data.fechas;
          // Eliminar estilo anterior si existe
          const oldStyle = document.getElementById('highlight-dates-style');
          if (oldStyle) {
            oldStyle.remove();
          }
          // Crear nuevo estilo
          const style = document.createElement('style');
          style.id = 'highlight-dates-style'; // ID para poder removerlo/actualizarlo
          // Esta forma de resaltar fechas directamente en el input[type="date"]
          // tiene un soporte limitado en navegadores. Una alternativa sería usar
          // una librería de datepicker que permita marcar días.
          // Por ahora, no agregaré estilos complejos que podrían no funcionar.
          // Lo más útil es tener la lista de fechas para el usuario.
          // Quizás podrías popular un <datalist> para el input.
          console.log("Fechas con registros históricos:", fechas);
          // Aquí podrías hacer algo más visual si encuentras una forma compatible
        }
      } catch (error) {
        console.error('Error al cargar fechas con registros:', error);
        // No es crítico, no mostrar mensaje de error al usuario por esto
      }
    };

    const configurarEventListeners = () => {
      if (!vinosTableBody || !fechaConsultaInput || !actualizarStockButton || !borrarStockButton) {
        console.error("Faltan elementos del DOM para configurar event listeners.");
        return;
      }

      vinosTableBody.addEventListener('input', (event) => {
        if (event.target.tagName === 'INPUT' && event.target.type === 'number') {
          if (statusMessageDiv) statusMessageDiv.textContent = ''; // Limpiar mensajes anteriores
          actualizarEstadoBoton(); // Habilitar/deshabilitar botón de actualizar
          
          // Debounce para autoguardado
          clearTimeout(debounceTimeout);
          debounceTimeout = setTimeout(() => {
            // Solo guardar si el botón de actualizar está habilitado (es decir, hay cambios válidos)
            if (!actualizarStockButton.disabled) {
                 // Y no estamos consultando una fecha histórica (porque entonces los cambios son para el actual)
                if (!fechaConsultaInput.value) { // Si no hay fecha seleccionada en el calendario
                    console.log("Autoguardando por input...");
                    guardarStockEnServidor();
                } else {
                    console.log("Cambio en input mientras se ve histórico. No se autoguarda. Use el botón 'Actualizar Stock' para guardar el estado actual.");
                    mostrarMensaje("Estás viendo un histórico. Los cambios se aplicarán al stock actual si presionas 'Actualizar Stock'.", false);
                }
            }
          }, 2000); // Aumentado a 2 segundos
        }
      });

      fechaConsultaInput.addEventListener('change', (event) => {
        const fecha = event.target.value;
        consultarStockHistorico(fecha);
      });

      actualizarStockButton.addEventListener('click', () => {
        // Al hacer clic en "Actualizar Stock", siempre se guarda el estado actual de la tabla,
        // independientemente de si se estaba viendo un histórico.
        // Si se estaba viendo un histórico y se modificaron valores, esos valores
        // ahora se guardarán como el stock actual.
        if (fechaConsultaInput.value) {
            alert("Estás guardando el contenido actual de la tabla como el nuevo stock. La fecha de consulta histórica será ignorada para esta acción.");
            fechaConsultaInput.value = ""; // Limpiar la fecha para reflejar que se opera sobre el stock actual
        }
        guardarStockEnServidor();
      });
      
      borrarStockButton.addEventListener('click', borrarStockActualEnServidor);
    };

    // --- Inicialización ---
    window.onload = () => {
      console.log('Página cargada, inicializando...');
      if (inicializarElementosDOM()) {
        console.log('Elementos del DOM inicializados correctamente');
        // generarTablaVinos se llama dentro de cargarDatosIniciales
        configurarEventListeners();
        cargarDatosIniciales(); // Esto ahora también genera la tabla
      } else {
        console.error('No se pudieron inicializar los elementos críticos del DOM. La aplicación puede no funcionar correctamente.');
        document.body.innerHTML = '<h1>Error Crítico</h1><p>No se pudieron cargar los componentes necesarios de la página. Por favor, recarga o contacta al administrador.</p>';
      }
    };
  </script>
</body>
</html>
